<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: '#eff6ff',
                100: '#dbeafe',
                500: '#3b82f6',
                600: '#2563eb',
                700: '#1d4ed8',
                900: '#1e3a8a'
              },
              zotoks: {
                50: '#f0f9ff',
                100: '#e0f2fe',
                500: '#0ea5e9',
                600: '#0284c7',
                700: '#0369a1',
                900: '#0c4a6e'
              }
            },
            animation: {
              'fade-in': 'fadeIn 0.15s ease-out',
              'bounce-gentle': 'bounceGentle 0.5s ease-out',
              'scale-in': 'scaleIn 0.2s ease-out'
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0', transform: 'translateY(4px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' }
              },
              bounceGentle: {
                '0%': { transform: 'scale(1)' },
                '50%': { transform: 'scale(1.02)' },
                '100%': { transform: 'scale(1)' }
              },
              scaleIn: {
                '0%': { transform: 'scale(0.98)', opacity: '0' },
                '100%': { transform: 'scale(1)', opacity: '1' }
              }
            }
          }
        }
      }
    </script>
    <style>
      /* Prevent body overflow */
      body {
        overflow: hidden;
        margin: 0;
        padding: 0;
      }
      
      /* Responsive container */
      .dialog-container {
        height: 100vh;
        width: 100vw;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem;
        box-sizing: border-box;
      }
      
      /* Main dialog card */
      .dialog-card {
        width: 100%;
        max-width: 36rem; /* 576px */
        height: 100%;
        max-height: calc(100vh - 1.5rem);
        display: flex;
        flex-direction: column;
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        border: 1px solid rgb(226 232 240);
        background: white;
      }
      
      /* Content area that adapts to available space */
      .content-area {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden; /* Prevent horizontal scroll */
        min-height: 0; /* Important for flex child */
        padding: 1rem;
        position: relative; /* For absolute positioned loading */
      }
      
      /* Footer always at bottom */
      .footer-area {
        flex-shrink: 0;
        border-top: 1px solid rgb(226 232 240);
        background: rgb(248 250 252);
        padding: 0.75rem 1rem;
      }
      
      /* Responsive adjustments */
      @media (max-height: 600px) {
        .dialog-container {
          padding: 0.25rem;
        }
        
        .content-area {
          padding: 0.75rem;
        }
        
        .footer-area {
          padding: 0.5rem 0.75rem;
        }
        
        /* Compact spacing for small heights */
        .space-y-3\.5 > * + * {
          margin-top: 0.75rem !important;
        }
      }
      
      @media (max-height: 500px) {
        .header-area {
          padding: 0.5rem 1rem;
        }
        
        .content-area {
          padding: 0.5rem;
        }
        
        .space-y-3\.5 > * + * {
          margin-top: 0.5rem !important;
        }
        
        /* Smaller text on very small screens */
        .dialog-card {
          font-size: 0.875rem;
        }
      }
      
      @media (max-width: 480px) {
        .dialog-container {
          padding: 0.25rem;
        }
        
        /* Stack buttons on very small screens */
        .button-container {
          flex-direction: column;
          gap: 0.5rem;
        }
        
        .button-container button {
          width: 100%;
        }
      }

      /* Loading overlay - covers entire dialog content */
      .loading-overlay {
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        border-radius: 0.75rem;
      }
      
      .loading-overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-slate-50 to-blue-50">
    <div class="dialog-container">
      <div class="dialog-card animate-scale-in relative">

        <!-- Loading Overlay -->
        <div class="loading-overlay hidden" id="loadingOverlay">
          <div class="text-center">
            <div class="w-5 h-5 border-2 border-slate-300 border-t-zotoks-600 rounded-full animate-spin mx-auto mb-2"></div>
            <p class="text-slate-600 font-medium text-sm" id="loadingText">Processing...</p>
            <p class="text-xs text-slate-500 mt-0.5" id="loadingSubtext">Please wait</p>
          </div>
        </div>

        <!-- Header -->
        <div class="header-area bg-gradient-to-r from-zotoks-600 to-zotoks-700 px-4 py-3">
          <div class="flex items-center gap-2">
            <div class="bg-white/20 rounded-lg p-1.5">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-3a1 1 0 011-1h2.586l6.243-6.243A6 6 0 0721 9z"></path>
              </svg>
            </div>
            <div>
              <h3 class="text-lg font-bold text-white">ZÃ¶tok API Credentials</h3>
              <p class="text-zotoks-100 text-xs">Configure your ZÃ¶tok workspace credentials</p>
            </div>
          </div>
        </div>

        <!-- Content -->
        <div class="content-area space-y-3.5">
          
          <!-- Information Panel -->
          <div class="bg-gradient-to-r from-blue-50 to-zotoks-50 rounded-lg p-3 border border-blue-200">
            <div class="flex items-start gap-2">
              <div class="bg-blue-100 rounded-full p-1 mt-0.5">
                <svg class="w-3.5 h-3.5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <div class="flex-1">
                <h4 class="font-medium text-blue-800 text-sm">Secure Storage</h4>
                <p class="text-blue-700 text-xs leading-relaxed">
                  Your credentials are stored securely within this Google Sheets document and are only used for Zotoks API authentication.
                </p>
              </div>
            </div>
          </div>
          
          <!-- Form Fields -->
          <div class="space-y-3">
            <div>
              <label for="workspaceId" class="block text-xs font-medium text-slate-700 mb-1.5">
                Workspace ID
              </label>
              <input type="text" id="workspaceId" placeholder="e.g., 6f3c81f1-13a3-4e0f-bfde-a2b71f2636bf"
                     class="w-full px-3 py-1.5 border-2 border-slate-200 rounded-lg text-sm font-mono hover:border-slate-300 focus:outline-none">
            </div>
            
            <div>
              <label for="clientId" class="block text-xs font-medium text-slate-700 mb-1.5">
                Client ID
              </label>
              <input type="text" id="clientId" placeholder="e.g., dde4018b3e7fc34c166b1c625660abc6"
                     class="w-full px-3 py-1.5 border-2 border-slate-200 rounded-lg text-sm font-mono hover:border-slate-300 focus:outline-none">
            </div>
            
            <div>
              <label for="clientSecret" class="block text-xs font-medium text-slate-700 mb-1.5">
                Client Secret
              </label>
              <div class="relative">
                <input type="password" id="clientSecret" placeholder="Enter your client secret..."
                       class="w-full px-3 py-1.5 pr-10 border-2 border-slate-200 rounded-lg text-sm font-mono hover:border-slate-300 focus:outline-none">
                <button type="button" onclick="togglePasswordVisibility()" 
                        class="absolute right-2 top-2 text-slate-400 hover:text-slate-600 transition-colors"
                        id="togglePassword">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="eyeIcon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Validation Messages -->
          <div class="validation-message hidden" id="validationMessage"></div>
          
          <!-- Loading State - Absolutely positioned to prevent layout shift -->
          <div class="loading hidden absolute inset-0 flex items-center justify-center bg-white/90 z-10" id="loadingDiv">
            <div class="bg-zotoks-50 rounded-lg p-4 text-center border border-zotoks-200 shadow-lg">
              <div class="flex items-center justify-center gap-2 text-zotoks-700">
                <div class="w-4 h-4 border-2 border-zotoks-300 border-t-zotoks-600 rounded-full animate-spin"></div>
                <span class="font-medium text-sm" id="loadingText">Saving credentials...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="footer-area">
          <div class="flex gap-2 justify-between button-container">
            <button onclick="goBackToImport()" id="backBtn"
                    class="px-4 py-1.5 bg-slate-100 text-slate-600 rounded-lg text-sm font-medium hover:bg-zotoks-50 hover:text-zotoks-700 hover:border-zotoks-300 transition-all duration-200 border border-slate-300 flex items-center gap-1.5">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
              </svg>
              <span class="hidden sm:inline">Back</span>
            </button>
            
            <div class="flex gap-2">
              <button onclick="closeDialog()" id="closeBtn"
                      class="px-4 py-1.5 bg-slate-200 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-300 transition-all duration-200 border border-slate-300">
                <span id="closeBtnText">Cancel</span>
              </button>
              <button onclick="saveCredentials()" id="saveBtn" disabled
                      class="px-4 py-1.5 bg-zotoks-600 text-white rounded-lg text-sm font-medium hover:bg-zotoks-700 transition-all duration-200 hover:shadow-md disabled:bg-slate-300 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none flex items-center gap-1.5">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Save
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ==========================================
      // OPTIMIZED INITIALIZATION - TASK 2
      // ==========================================
      
      // Global state to prevent redundant operations
      let isInitialized = false;
      let credentialsLoaded = false;
      
      // Optimized DOMContentLoaded handler
      document.addEventListener('DOMContentLoaded', function() {
        if (isInitialized) return;
        isInitialized = true;
        
        console.log('ðŸš€ Credentials dialog initializing...');
        
        // Initialize form validation immediately (no delay)
        initializeFormValidation();
        
        // Load credentials in background without blocking UI
        loadExistingCredentialsOptimized();
        
        // Auto-focus with minimal delay
        requestAnimationFrame(() => {
          document.getElementById('workspaceId').focus();
        });
        
        console.log('âœ… Credentials dialog initialized');
      });
      
      function initializeFormValidation() {
        const inputs = ['workspaceId', 'clientId', 'clientSecret'];
        inputs.forEach(inputId => {
          const input = document.getElementById(inputId);
          
          // Immediate event listeners (no setTimeout)
          input.addEventListener('input', validateForm);
          input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              const nextInput = inputs[inputs.indexOf(inputId) + 1];
              if (nextInput) {
                document.getElementById(nextInput).focus();
              } else if (!document.getElementById('saveBtn').disabled) {
                saveCredentials();
              }
            }
          });
        });
      }
      
      // ==========================================
      // OPTIMIZED CREDENTIAL LOADING - TASK 2
      // ==========================================
      
      function loadExistingCredentialsOptimized() {
        // Skip if already loaded to prevent redundant calls
        if (credentialsLoaded) {
          console.log('ðŸ“‹ Credentials already loaded, skipping...');
          return;
        }
        
        console.log('ðŸ“‹ Loading existing credentials...');
        
        // Use timeout to prevent blocking UI thread
        const timeoutId = setTimeout(() => {
          console.warn('âš ï¸ Credential loading timeout - continuing without');
          credentialsLoaded = true;
        }, 2000); // 2 second timeout
        
        google.script.run
          .withSuccessHandler((result) => {
            clearTimeout(timeoutId);
            handleExistingCredentialsOptimized(result);
            credentialsLoaded = true;
            console.log('âœ… Credentials loaded successfully');
          })
          .withFailureHandler((error) => {
            clearTimeout(timeoutId);
            console.log('â„¹ï¸ No existing credentials found:', error.message);
            credentialsLoaded = true;
          })
          .dispatch('getCredentials');
      }
      
      function handleExistingCredentialsOptimized(result) {
        if (result.success && result.credentials) {
          const creds = result.credentials;
          
          // Batch DOM updates to prevent reflow
          const updates = [
            ['workspaceId', creds.workspaceId || ''],
            ['clientId', creds.clientId || ''],
            ['clientSecret', creds.clientSecret || '']
          ];
          
          // Apply all updates at once
          requestAnimationFrame(() => {
            updates.forEach(([id, value]) => {
              document.getElementById(id).value = value;
            });
            validateForm();
            showToastOptimized('Existing credentials loaded', 'info');
          });
        }
      }
      
      // ==========================================
      // OPTIMIZED UI FUNCTIONS - TASK 2
      // ==========================================
      
      function showToastOptimized(message, type, duration = 3000) {
        // Optimize toast creation with less DOM manipulation
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-6 py-3 rounded-md font-medium z-50 transition-all shadow-lg max-w-sm ${
          type === 'success' ? 'bg-green-600 text-white' : 
          type === 'info' ? 'bg-blue-600 text-white' : 
          type === 'error' ? 'bg-red-600 text-white' : 'bg-slate-600 text-white'
        }`;
        toast.textContent = message;
        toast.style.transform = 'translateX(100%)';
        toast.style.opacity = '0';
        
        document.body.appendChild(toast);
        
        // Use requestAnimationFrame for smoother animations
        requestAnimationFrame(() => {
          toast.style.transform = 'translateX(0)';
          toast.style.opacity = '1';
        });
        
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(100%)';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }
      
      // ==========================================
      // OPTIMIZED NAVIGATION - TASK 2
      // ==========================================
      
      function goBackToImport() {
        console.log('ðŸ”„ Navigating back to import dialog...');
        
        // Immediate close without waiting for server response
        // The main dialog will reopen automatically through the existing flow
        google.script.run
          .withSuccessHandler(() => {
            google.script.host.close();
          })
          .withFailureHandler((error) => {
            console.error('Error reopening import dialog:', error);
            google.script.host.close();
          })
          .showZotoksImportDialog();
        // Note: Removed the unnecessary server call that was causing delay
        // The parent dialog handles reopening correctly without our intervention
      }
      
      function closeDialog() {
        // Immediate close
        google.script.host.close();
      }
      
      // ==========================================
      // EXISTING FUNCTIONS (OPTIMIZED)
      // ==========================================
      
      function togglePasswordVisibility() {
        const passwordInput = document.getElementById('clientSecret');
        const eyeIcon = document.getElementById('eyeIcon');
        
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          eyeIcon.innerHTML = `
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
          `;
        } else {
          passwordInput.type = 'password';
          eyeIcon.innerHTML = `
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          `;
        }
      }
      
      function validateForm() {
        const workspaceId = document.getElementById('workspaceId').value.trim();
        const clientId = document.getElementById('clientId').value.trim();
        const clientSecret = document.getElementById('clientSecret').value.trim();
        
        const isValid = workspaceId && clientId && clientSecret;
        const saveBtn = document.getElementById('saveBtn');
        
        // Enable save button if all fields are filled
        saveBtn.disabled = !isValid;
        
        // Clear validation messages on form change
        hideValidation();
        
        // Basic validation feedback
        if (isValid) {
          // Validate UUID format for workspaceId
          const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
          if (!uuidRegex.test(workspaceId)) {
            showValidation('Workspace ID should be in UUID format (e.g., 6f3c81f1-13a3-4e0f-bfde-a2b71f2636bf)', 'warning');
            return;
          }
          
          if (clientId.length < 10) {
            showValidation('Client ID appears to be too short', 'warning');
            return;
          }
          
          if (clientSecret.length < 20) {
            showValidation('Client Secret appears to be too short', 'warning');
            return;
          }
          
          showValidation('âœ“ All fields look good. Ready to save!', 'success');
        }
      }
      
      function saveCredentials() {
        const workspaceId = document.getElementById('workspaceId').value.trim();
        const clientId = document.getElementById('clientId').value.trim();
        const clientSecret = document.getElementById('clientSecret').value.trim();
        
        if (!workspaceId || !clientId || !clientSecret) {
          showValidation('Please fill in all credential fields', 'error');
          return;
        }
        
        showLoading(true, 'Saving credentials...');
        
        google.script.run
          .withSuccessHandler(handleSaveResult)
          .withFailureHandler(handleSaveError)
          .dispatch('storeCredentials', { workspaceId, clientId, clientSecret });
      }
      
      function handleSaveResult(result) {
        showLoading(false);
        
        if (result.success) {
          showToastOptimized('Credentials saved successfully!', 'success');
          
          // Update UI to show success - batch DOM updates
          requestAnimationFrame(() => {
            document.getElementById('closeBtnText').textContent = 'Close';
            const closeBtn = document.getElementById('closeBtn');
            closeBtn.classList.remove('bg-slate-200', 'text-slate-700');
            closeBtn.classList.add('bg-green-600', 'text-white');
            
            const backBtn = document.getElementById('backBtn');
            backBtn.classList.remove('bg-slate-100', 'text-slate-600');
            backBtn.classList.add('bg-zotoks-600', 'text-white');
            backBtn.innerHTML = `
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
              </svg>
              <span class="hidden sm:inline">Back to Import Data</span>
            `;
            
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = `Saved âœ“`;
          });
          
          showValidation('âœ… Credentials saved successfully! Click "Back to Import Data" to continue.', 'success');
        } else {
          showValidation('Error saving credentials: ' + result.message, 'error');
        }
      }
      
      function handleSaveError(error) {
        showLoading(false);
        showValidation('Error saving credentials: ' + error.message, 'error');
      }
      
      function showValidation(message, type) {
        const validationDiv = document.getElementById('validationMessage');
        validationDiv.textContent = message;
        
        let className = 'validation-message p-4 rounded-lg text-sm font-medium animate-fade-in ';
        if (type === 'error') {
          className += 'bg-red-50 text-red-700 border border-red-200';
        } else if (type === 'success') {
          className += 'bg-green-50 text-green-700 border border-green-200';
        } else if (type === 'warning') {
          className += 'bg-amber-50 text-amber-700 border border-amber-200';
        } else {
          className += 'bg-blue-50 text-blue-700 border border-blue-200';
        }
        
        validationDiv.className = className;
        validationDiv.classList.remove('hidden');
      }
      
      function hideValidation() {
        document.getElementById('validationMessage').classList.add('hidden');
      }
      
      function showLoading(show, text = 'Processing...', subtext = 'Please wait') {
        const overlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const loadingSubtext = document.getElementById('loadingSubtext');
        const saveBtn = document.getElementById('saveBtn');

        if (show) {
          loadingText.textContent = text;
          loadingSubtext.textContent = subtext;
          overlay.classList.remove('hidden');
          saveBtn.disabled = true;
        } else {
          overlay.classList.add('hidden');
          validateForm(); // Re-validate to restore button state
        }
      }
      
      function handleError(error) {
        console.error('Error:', error);
        showToastOptimized('Error: ' + error.message, 'error');
      }
    </script>
  </body>
</html>